package uet.barrydevp.towerdefense.Entity.Tower;import javafx.geometry.Point2D;import uet.barrydevp.towerdefense.Entity.BaseEntity;import uet.barrydevp.towerdefense.Game.GameAudio;import uet.barrydevp.towerdefense.Game.GameManager;import uet.barrydevp.towerdefense.Game.GameMenu;import uet.barrydevp.towerdefense.Entity.Monster.BaseMonster;import uet.barrydevp.towerdefense.Sprite.BaseSprite;import uet.barrydevp.towerdefense.Sprite.TowerSprite;import java.util.ArrayList;public abstract class BaseTower extends BaseEntity {    public static final String FIRE_EFFECT = "FIRE_EFFECT";    private static final int OFFSET_OF_CENTER = 32;    private TowerName towerName;//    private BaseSprite baseSprite;    private int level;    private double scope;    private double nextScope;    private double rate;    private double elapsedShoot;    private int force;    private int updateMoney;    private int buildMoney;    private BaseMonster nearestMonster;    public BaseTower() {        baseSprite = null;        elapsedShoot = 0;        level = 0;        scope = 0;        nextScope = 0;        rate = 0;        force = 0;        updateMoney = 0;        buildMoney = 0;        nearestMonster = null;        layer = GameManager.getInstance().getTowerLayer();    }    public abstract boolean init();    public void setTowerName(TowerName towerName) {        this.towerName = towerName;    }    public TowerName getTowerName() {        return towerName;    }    public BaseSprite getBaseSprite() {        return baseSprite;    }    public void setBaseSprite(BaseSprite baseSprite) {        this.baseSprite = baseSprite;    }    public int getLevel() {        return level;    }    public void setLevel(int level) {        this.level = level;    }    public BaseMonster getNearestMonster() {        return nearestMonster;    }    public void setNearestMonster(BaseMonster nearestMonster) {        this.nearestMonster = nearestMonster;    }    public double getScope() {        return scope;    }    public void setScope(double scope) {        this.scope = scope;        ((TowerSprite)baseSprite).setScopeCircle(scope);    }    public int getForce() {        return force;    }    public void setForce(int force) {        this.force = force;    }    public int getBuildMoney() {        return buildMoney;    }    public void setBuildMoney(int buildMoney) {        this.buildMoney = buildMoney;    }    public double getNextScope() {        return nextScope;    }    public void setNextScope(double nextScope) {        this.nextScope = nextScope;    }    public double getRate() {        return rate;    }    public void setRate(double rate) {        this.rate = rate;        this.elapsedShoot = rate;    }    public double getElapsedShoot() {        return elapsedShoot;    }    public void setElapsedShoot(double elapsedShoot) {        this.elapsedShoot = elapsedShoot;    }    public int getUpdateMoney() {        return updateMoney;    }    public void setUpdateMoney(int updateMoney) {        this.updateMoney = updateMoney;    }    public abstract void upgradeTower();    public void buildTower(BaseTower tower) {        GameManager instance = GameManager.getInstance();//        System.out.println(instance.getMoney());//        System.out.println(tower.getBuildMoney());        int tmpMoney = instance.getMoney() - tower.getBuildMoney();        if(tmpMoney >= 0) {            // Sound Building Tower            GameAudio.getInstance().onSoundBuildingTower();            removeTower();            instance.setMoney(tmpMoney);            instance.getTowerArray().add(tower);            GameMenu.getInstance().updateMessage("-" + tower.getBuildMoney() + "$");        } else {            tower.removeTower();            System.out.println("Haven't enought gold to build this Tower!");            GameMenu.getInstance().updateMessage("Haven't enought gold to build this Tower!");        }    }    public void sellTower() {        GameManager instance = GameManager.getInstance();        int tmpMoney = instance.getMoney() + Math.round(buildMoney * 0.7f);        instance.setMoney(tmpMoney);//        instance.setMoney(buildMoney);        GameMenu.getInstance().updateMessage("+" + Math.round(buildMoney * 0.7f) + "$");        removeTower();    }    public void removeTower() {        GameManager instance = GameManager.getInstance();        instance.getTowerArray().remove(this);        removeFromLayer();        for(int i = instance.getRootTowerArray().size() - 1; i >= 0; --i) {            instance.getRootTowerArray().get(i).reload(); // repaint rootTower        }//        layer.getChildren().add(new RootTower(baseSprite.getCenterLocation()));    }    public void removeFromLayer() {        super.removeFromLayer();        ((TowerSprite)baseSprite).removeScope();    }    public void checkNearestMonster() {        GameManager instance = GameManager.getInstance();        ArrayList<BaseMonster> monsterArray = instance.getMonsterArray();        double curMinDistance = scope; // to get the nearest monster        BaseMonster tmpMonster = null;        // algorithm to attack nearest monster        for(int i = 0; i < monsterArray.size(); ++i) {            BaseMonster monster = monsterArray.get(i);            double distance = monster.getBaseSprite().getCenterLocation().distance(baseSprite.getCenterLocation());            if(distance < curMinDistance) {                curMinDistance = distance;                tmpMonster = monster;            }        }        // algorithm to attack oldest monster ( co nghia la uu tien cac quai ra dau tien hon )//        for(int i = 0; i < monsterArray.size(); ++i) {//            BaseMonster monster = monsterArray.get(i);////            double distance = monster.getBaseSprite().getCenterLocation().distance(baseSprite.getCenterLocation());//            if(distance < curMinDistance) {//                tmpMonster = monster;//                break;//            }//        }        nearestMonster = tmpMonster;    }    public void shoot(double dt) {        GameManager instance = GameManager.getInstance();//        System.out.println(baseSprite.getChildrenSprite().get(FIRE_EFFECT));        // render effect fire        if(baseSprite.getChildrenSprite() != null && baseSprite.getChildrenSprite().get(FIRE_EFFECT) != null && baseSprite.getChildrenSprite().get(FIRE_EFFECT).isVisible() && elapsedShoot > 0.3) {            baseSprite.setVisibleChild(FIRE_EFFECT, false);//            System.out.println("A");        }        if(elapsedShoot > rate){            checkNearestMonster();            if(nearestMonster != null && nearestMonster.getCurHp() > 0) {                Point2D vectorShoot = nearestMonster.getBaseSprite().getCenterLocation().subtract(baseSprite.getCenterLocation());                double alpha = Math.atan2(vectorShoot.getY(), vectorShoot.getX());                baseSprite.update(getBaseSprite().getCenterLocation(), Math.toDegrees(alpha));//                ((TowerSprite)baseSprite).getImageView().setRotate(Math.toDegrees(baseSprite.getOriginalR() + alpha));                double dx = OFFSET_OF_CENTER * Math.cos(alpha);                double dy = OFFSET_OF_CENTER * Math.sin(alpha);                if(baseSprite.getChildrenSprite() != null && baseSprite.getChildrenSprite().get(FIRE_EFFECT) != null) {                    baseSprite.setVisibleChild(FIRE_EFFECT, true);                    baseSprite.getChildrenSprite().get(FIRE_EFFECT).update(getBaseSprite().getCenterLocation().add(new Point2D((OFFSET_OF_CENTER + 10) * Math.cos(alpha), (OFFSET_OF_CENTER + 10) * Math.sin(alpha))), Math.toDegrees(alpha));//                    baseSprite.getChildrenSprite().get(0).update(new Point2D(0,0)/*.add(new Point2D(dx, dy))*/, Math.toDegrees(alpha));                }                createBullet(nearestMonster, getBaseSprite().getCenterLocation().add(new Point2D(dx, dy)));            }            elapsedShoot = 0;        } else {            elapsedShoot += dt;        }    }    public void update(double dt) {        shoot(dt);    }    public abstract void createBullet(BaseMonster targetMonster, Point2D center);}